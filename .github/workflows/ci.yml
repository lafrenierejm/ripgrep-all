# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
---
on:
  pull_request:

name: ci

env:
  CACHIX_CACHE: ${{ github.repository_owner }}
  CACHIX_AUTH_TOKEN: ${{ secrets.CACHIX_AUTH_TOKEN }}
  CACHIX_SIGNING_KEY: ${{ secrets.CACHIX_SIGNING_KEY }}

jobs:
  nix-flake-check:
    name: nix flake check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v6

      - name: Install nix
        uses: cachix/install-nix-action@v31
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Export current system
        run:
          echo "NIX_SYSTEM=$(nix eval --raw --impure --expr builtins.currentSystem)" >> "$GITHUB_ENV"

      - name: Ensure the build succeeds
        run: >
          nix run github:Mic92/nix-fast-build
          --
          --flake .#packages."$NIX_SYSTEM".default
          --no-nom
          --skip-cached
          --cachix-cache "$CACHIX_CACHE"

      - name: Eval checks to run formatters, linters, and tests
        run: >
          nix run github:Mic92/nix-fast-build
          --
          --flake .#checks."$NIX_SYSTEM"
          --no-nom
          --skip-cached
          --cachix-cache "$CACHIX_CACHE"
